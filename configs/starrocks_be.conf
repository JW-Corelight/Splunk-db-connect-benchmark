# StarRocks Backend Configuration - M3 Optimized
# Purpose: Optimize BE for Rosetta 2 translation overhead
# Last Updated: December 7, 2024

# ===========================================
# System Settings
# ===========================================
sys_log_level = WARN
be_port = 9060
be_http_port = 8040
heartbeat_service_port = 9050
brpc_port = 8060
starlet_port = 9070

# ===========================================
# Storage Paths
# ===========================================
storage_root_path = ${STARROCKS_HOME}/storage
sys_log_dir = ${STARROCKS_HOME}/log
user_function_dir = ${STARROCKS_HOME}/lib/udf

# ===========================================
# Memory Configuration
# ===========================================
mem_limit = 85%
chunk_reserved_bytes_limit = 2147483648  # 2GB
storage_page_cache_limit = 10%

# ===========================================
# Thread Configuration (Adjusted for Rosetta)
# ===========================================
scanner_thread_pool_thread_num = 12
pipeline_exec_thread_pool_thread_num = 0  # Auto-detect
pipeline_sink_io_thread_pool_thread_num = 4
storage_page_cache_shard_size = 16

# ===========================================
# Query Execution
# ===========================================
vector_chunk_size = 4096
max_scan_key_num = 1024
max_pushdown_conditions_per_column = 1024
default_query_options = query_timeout=300

# ===========================================
# Network Configuration
# ===========================================
priority_networks = 172.28.0.0/16
thrift_port = 9060
brpc_num_threads = -1  # Auto-detect

# ===========================================
# Storage Engine
# ===========================================
create_tablet_worker_count = 2
tablet_map_shard_size = 32
max_tablet_num_per_shard = 1024

# ===========================================
# Compaction (Tuned for M3 SSD)
# ===========================================
max_compaction_threads = 4
cumulative_compaction_num_threads_per_disk = 2
base_compaction_num_threads_per_disk = 1
compaction_trace_threshold = 60
compaction_task_num_per_disk = 2

# ===========================================
# RPC Settings
# ===========================================
brpc_socket_max_unwritten_bytes = 1073741824  # 1GB
brpc_max_body_size = 3221225472  # 3GB

# ===========================================
# Streaming Load
# ===========================================
streaming_load_max_mb = 10240  # 10GB
streaming_load_rpc_max_alive_time_sec = 1200

# ===========================================
# Cache Settings
# ===========================================
disable_storage_page_cache = false
enable_bitmap_union_disk_format_with_set = true

# ===========================================
# Query Cache
# ===========================================
query_cache_capacity = 536870912  # 512MB

# ===========================================
# Runtime Filter
# ===========================================
runtime_filter_cache_size = 536870912  # 512MB

# ===========================================
# Advanced Settings
# ===========================================
enable_token_check = false
enable_metric_calculator = true
enable_system_metrics = true
enable_prefetch = true

# ===========================================
# Logging
# ===========================================
sys_log_roll_mode = SIZE-MB-1024
sys_log_roll_num = 10
sys_log_verbose_modules = olap

# ===========================================
# M3-Specific (via Rosetta)
# ===========================================
# Note: Running via Rosetta 2 translation
# Expect 15-20% performance overhead
# Thread counts are conservative to reduce translation impact
