#!/bin/bash
# Claude Code Session Start Hook
# Displays project status, git info, and Docker service health

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$PROJECT_ROOT" || exit 0

PROJECT_NAME=$(basename "$PROJECT_ROOT")

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  ğŸ“Š ${PROJECT_NAME}${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Git Information
if [ -d ".git" ]; then
    BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
    UNCOMMITTED=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')

    echo -e "${BLUE}ğŸ“ Git Status:${NC}"
    echo -e "   Branch: ${GREEN}$BRANCH${NC}"

    if [ "$UNCOMMITTED" -eq 0 ]; then
        echo -e "   Changes: ${GREEN}None (clean)${NC}"
    else
        echo -e "   Changes: ${YELLOW}$UNCOMMITTED uncommitted${NC}"
    fi

    echo ""
    echo -e "${BLUE}ğŸ“ Recent Commits:${NC}"
    git log --oneline --decorate --color=always -3 2>/dev/null | sed 's/^/   /' || echo "   No commits yet"
else
    echo -e "${YELLOW}âš ï¸  Not a git repository${NC}"
fi

echo ""

# Docker Service Status
echo -e "${BLUE}ğŸ³ Docker Services:${NC}"
if command -v docker-compose &> /dev/null; then
    if [ -f "docker-compose.m3.yml" ]; then
        COMPOSE_FILE="docker-compose.m3.yml"
    else
        COMPOSE_FILE="docker-compose.yml"
    fi

    RUNNING=$(docker-compose -f "$COMPOSE_FILE" ps --services --filter "status=running" 2>/dev/null | wc -l | tr -d ' ')
    TOTAL=$(docker-compose -f "$COMPOSE_FILE" ps --services 2>/dev/null | wc -l | tr -d ' ')

    if [ "$TOTAL" -gt 0 ]; then
        if [ "$RUNNING" -eq "$TOTAL" ]; then
            echo -e "   Status: ${GREEN}$RUNNING/$TOTAL services running${NC}"
        elif [ "$RUNNING" -gt 0 ]; then
            echo -e "   Status: ${YELLOW}$RUNNING/$TOTAL services running${NC}"
        else
            echo -e "   Status: ${RED}No services running${NC}"
        fi
    else
        echo -e "   ${YELLOW}No services configured/started${NC}"
    fi
else
    echo -e "   ${YELLOW}docker-compose not available${NC}"
fi

echo ""

# Project Status
echo -e "${BLUE}ğŸ“‹ Project Status:${NC}"
if [ -f "IMPLEMENTATION_SUMMARY.md" ]; then
    echo -e "   ${GREEN}~85% complete${NC} (see IMPLEMENTATION_SUMMARY.md)"
else
    echo -e "   Active development"
fi

echo ""

# Quick Tips
echo -e "${BLUE}ğŸ’¡ Quick Commands:${NC}"
echo -e "   ${GREEN}/status${NC}    - Check Docker services"
echo -e "   ${GREEN}/validate${NC}  - Validate environment health"
echo -e "   ${GREEN}/benchmark${NC} - Run all benchmarks"
echo -e "   ${GREEN}/cleanup${NC}   - Clean up environment"

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Always exit 0 (non-blocking)
exit 0
